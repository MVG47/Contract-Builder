<html>
	<head>
		<!-- Load jQuery, Vue and Sheetrock from CDNJS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.1.4/dist/sheetrock.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.css">

		<style>
			body {
				background-color: #e3f5df;
			}
			#start-btn{
				margin-top: 200px !important;
				height: 100px;
				width: 200px;
			}
			#main .btn{
				margin: 0 auto;
				display: block;
			}
			#main {
				width: 900px;
				margin: 0 auto;
			}
			@media print
			{
				.no-print, .no-print *
				{
					display: none !important;
				}
			}
		</style>
	</head>
	<body>
		<div id="main">
			<!--all content goes here-->
			<div id="content">

			</div>
		</div>
	</body>
	<footer>
		<script>
			// globals
			var docObject = [];
			var collDependency = [];
			var collection;

			function findFather(objSearch, objAdd, idx)
			{
				debugger;
				var found = false;
				objSearch.filter(function(item){ // find item father of the dependency
					debugger;
					if (!found)
					{
						if (item.id === objAdd.depends)
						{
							collDependency.splice(idx, 1); // remove current item
							item.childs.push(objAdd);
							found = true;
						}
						else if (item.childs.length > 0)
						{
							found = findFather(item.childs, objAdd, idx);
						}
					}
				});
				return found;
			}

			var myCallback = function (error, options, response) {
				if (!error) {
					//console.log(response.rows);
					// making sure it will work even if order changes
					var idIndex = response.rows[0].labels.indexOf('id');
					var descriptionIndex = response.rows[0].labels.indexOf('description');
					var contentIndex = response.rows[0].labels.indexOf('content');
					var typeIndex = response.rows[0].labels.indexOf('type');
					var dependsIndex = response.rows[0].labels.indexOf('depends');
					var mandatoryIndex = response.rows[0].labels.indexOf('mandatory');

					collection = response.rows.slice(1, response.rows.length); // remove labels
					collection.filter(function(item){ // get all objects that has no dependency
						debugger;
						if (item.cellsArray[dependsIndex] === "")
						{
							var tempObject = Object();
							tempObject.id = item.cellsArray[idIndex];
							tempObject.description = item.cellsArray[descriptionIndex];
							tempObject.content = item.cellsArray[contentIndex];
							tempObject.type = item.cellsArray[typeIndex];
							tempObject.depends = item.cellsArray[dependsIndex];
							tempObject.mandatory = item.cellsArray[mandatoryIndex];
							tempObject.childs = [];

							docObject.push(tempObject);
						}
					});
					collDependency = collection.filter(function(item){ // get all objects that has dependency
						return (item.cellsArray[dependsIndex] !== "");
					});
					// TODO add while to deep decision tree
					var tempColl = [];
					var i = 0;
					var stop = false;
					var message = "";
					//while (collDependency.length > 0) {
					while ((!stop) && (collDependency.length > 0)) {
						tempColl = collDependency;
						$(tempColl).each(function(index){
							if (!stop)
							{
								var tempObject = Object();
								tempObject.id = this.cellsArray[idIndex];
								tempObject.description = this.cellsArray[descriptionIndex];
								tempObject.content = this.cellsArray[contentIndex];
								tempObject.type = this.cellsArray[typeIndex];
								tempObject.depends = this.cellsArray[dependsIndex];
								tempObject.mandatory = this.cellsArray[mandatoryIndex];
								tempObject.childs = [];

								if (tempObject.id === tempObject.depends)
								{
									stop = true;
									message = "an item cannot depend of itself";
									return;
								}

								stop = !findFather(docObject, tempObject, index - i);
								i++;
							}
						});

						if (stop)
						{
							if (message !== "")
								window.alert(message);
						}
					}

					//debugger;
					localStorage.setItem('CG-decisionsTree', JSON.stringify(docObject));

					var startBtn = $('<input/>').attr({class:'btn btn-primary', id:'start-btn', type: 'button', value:'Start', onClick:'startDecisions()'});
					$("#content").append(startBtn);
				}
			};
			sheetrock({
				url: "https://docs.google.com/spreadsheets/d/1HFGm_cSH_XeZtxfREusftu-4S1LYZeAVSVjWMmsRHtY/edit#gid=0",
				callback: myCallback
			});

			function toggleItem(id){
				$('#' + id).toggle();
			}

			function startDecisions(){
				window.alert('hello world');
				$("#start-btn").toggle();
				var decisionsDiv = $('<div/>').attr({id:'decisions'});
				var decisionsTree = JSON.parse(localStorage.getItem('CG-decisionsTree'));
				// TODO add while to deep decision tree
				$(decisionsTree).each(function(){
					var id = 'div-' + this.id;
					var innerDiv = $('<div/>').attr({class:'inner-div', id:id});
					var toggle = $('<input/>').attr({type:'checkbox', class:'no-print', onchange:"toggleItem('" + id + "')"});
					var description = $("<h3>").text('Description: ' + this.description).attr({class:'no-print'});
					var htmlTag = "";
					if (this.type === 'paragraph')
						htmlTag = "<p>";
					else if (this.type === 'title')
						htmlTag = "<h1>";
					else if (this.type === 'subtitle')
						htmlTag = "<h2>";

					var paragraph = $(htmlTag).text(this.content);
					innerDiv.append(description).append(paragraph);
					if (this.childs.length > 0)
					{
						$(this.childs).each(function(){
							var id = 'div-' + this.id;
							var tempDiv = $('<div/>').attr({class:'inner-div', id:id});
							var innerToggle = $('<input/>').attr({type:'checkbox', class:'no-print', onchange:"toggleItem('" + id + "')"});
							var description = $("<h3>").text('Description: ' + this.description).attr({class:'no-print'});
							var htmlTag = "";
							if (this.type === 'paragraph')
								htmlTag = "<p>";
							else if (this.type === 'title')
								htmlTag = "<h1>";
							else if (this.type === 'subtitle')
								htmlTag = "<h2>";

							var paragraph = $(htmlTag).text(this.content);
							tempDiv.append(description).append(paragraph);
							innerDiv.append(innerToggle).append(tempDiv);
						});
					}
					decisionsDiv.append(toggle).append(innerDiv);
				});
				$("#content").append(decisionsDiv);
				var printBtn = $('<input/>').attr({class:'btn btn-success no-print', id:'print-btn', type: 'button', value:'Print', onClick:'preparePrint()'});
				$("#decisions").append(printBtn);
			}
			function preparePrint()
			{

				window.print();
			}
		</script>
	</footer>
</html>