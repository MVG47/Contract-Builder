<html>
	<head>
		<!-- Load jQuery, Vue and Sheetrock from CDNJS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.js"></script>-->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.1.4/dist/sheetrock.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.css">

		<style>
			body {
				background-color: #e3f5df;
			}
			#start-btn{
				margin-top: 200px !important;
				height: 100px;
				width: 200px;
			}
			#main .btn{
				margin: 0 auto;
				display: block;
			}
			#content {
				width: 210mm;
				padding-left: 0;
				float: left;
				padding: 30mm 20mm 20mm 30mm;
				/*background: #ffffff;*/
			}
			#vars-menu {
				display: none;
				width: 400px;
				padding: 5px;
				background: rgb(221, 221, 221);
				margin-left: 210mm;
				position: absolute;
			}
			#print {
				width: 100%;
				margin-bottom: 10px;
			}
			#main {
				width: 900px;
				margin: 0 auto;
			}
			#parse-sheet {
				margin-top: 200px;
			}
			#sheet-input {
				width: 100%;
			}
			.align-center {
				text-align: center;
			}
			.vue-var {
				float: right;
			}
			.btn-pick{
				float: left;
				margin: 10px !important;
			}
			@media print
			{
				.no-print, .no-print *
				{
					display: none !important;
				}
			}
		</style>
	</head>
	<body>
		<div id="main">
			<!--all content goes here-->
			<div id="content">

			</div>
			<div id="vars-menu" class="no-print">
				<input id="print" type="button" onclick="preparePrint()" value="Print!">
			</div>
		</div>
	</body>
	<footer>
		<script>
			// globals
			var docObject = [];
			var collDependency = [];
			var collection;

			function findFather(objSearch, objAdd, idx)
			{
				var found = false;
				objSearch.filter(function(item){ // find item father of the dependency
					if (!found)
					{
						if (item.id === objAdd.depends)
						{
							collDependency.splice(idx, 1); // remove current item
							item.childs.push(objAdd);
							found = true;
						}
						else if (item.childs.length > 0)
						{
							found = findFather(item.childs, objAdd, idx);
						}
					}
				});
				return found;
			}

			var myCallback = function (error, options, response) {
				if (!error) {
					//console.log(response.rows);
					// making sure it will work even if order changes
					var idIndex = response.rows[0].labels.indexOf('id');
					var descriptionIndex = response.rows[0].labels.indexOf('description');
					var contentIndex = response.rows[0].labels.indexOf('content');
					var typeIndex = response.rows[0].labels.indexOf('type');
					var dependsIndex = response.rows[0].labels.indexOf('depends');
					var mandatoryIndex = response.rows[0].labels.indexOf('mandatory');

					collection = response.rows.slice(1, response.rows.length); // remove labels
					collection.filter(function(item){ // get all objects that has no dependency
						if (item.cellsArray[dependsIndex] === "")
						{
							var tempObject = Object();
							tempObject.id = item.cellsArray[idIndex];
							tempObject.description = item.cellsArray[descriptionIndex];
							tempObject.content = item.cellsArray[contentIndex];
							tempObject.type = item.cellsArray[typeIndex];
							tempObject.depends = item.cellsArray[dependsIndex];
							tempObject.mandatory = item.cellsArray[mandatoryIndex];
							tempObject.used = false;
							tempObject.childs = [];

							docObject.push(tempObject);
						}
					});
					collDependency = collection.filter(function(item){ // get all objects that has dependency
						return (item.cellsArray[dependsIndex] !== "");
					});
					// TODO add while to deep decision tree
					var tempColl = [];
					var i = 0;
					var stop = false;
					var message = "";
					//while (collDependency.length > 0) {
					while ((!stop) && (collDependency.length > 0)) {
						tempColl = collDependency;
						$(tempColl).each(function(index){
							if (!stop)
							{
								var tempObject = Object();
								tempObject.id = this.cellsArray[idIndex];
								tempObject.description = this.cellsArray[descriptionIndex];
								tempObject.content = this.cellsArray[contentIndex];
								tempObject.type = this.cellsArray[typeIndex];
								tempObject.depends = this.cellsArray[dependsIndex];
								tempObject.mandatory = this.cellsArray[mandatoryIndex];
								tempObject.used = false;
								tempObject.childs = [];

								if (tempObject.id === tempObject.depends)
								{
									stop = true;
									message = "an item cannot depend of itself";
									return;
								}

								stop = !findFather(docObject, tempObject, index - i);
								i++;
							}
						});

						if (stop)
						{
							if (message !== "")
								window.alert(message);
						}
					}

					localStorage.setItem('CG-decisionsTree', JSON.stringify(docObject));
					localStorage.removeItem('CG-brothersIds');
					localStorage.removeItem('CG-vueVars');

					var startBtn = $('<input/>').attr({class:'btn btn-primary', id:'start-btn', type: 'button', value:'Start', onClick:'startDecisions()'});
					$("#content").append(startBtn);
				}
			};
			var sheetId = getURLParam("sheetId"); // 1HFGm_cSH_XeZtxfREusftu-4S1LYZeAVSVjWMmsRHtY
			if (sheetId)
			{
				sheetrock({
					url: "https://docs.google.com/spreadsheets/d/" + sheetId + "/edit#gid=0",
					callback: myCallback
				});
			}
			else{
				var innerDiv = $('<div/>').attr({id:'parse-sheet'});
				var paragraph = $('<p>').text("Paste your spreadsheet URL").attr({class:'align-center'});
				var input = $('<input/>').attr({type:'text', id:'sheet-input', placeholder:'Example: https://docs.google.com/spreadsheets/d/1HFGm_cSH_XeZtxfREusftu-4S1LYZeAVSVjWMmsRHtY/edit#gid=0'});
				var startBtn = $('<input/>').attr({class:'btn btn-primary', id:'sheet-btn', type: 'button', value:'Go!', onClick:'parseSpreadsheet()'});
				paragraph.append(input);
				innerDiv.append(paragraph).append(startBtn);
				$("#content").append(innerDiv);
			}

			function parseSpreadsheet()
			{
				var resourceUrl = $("#sheet-input").val();
				var spreadsheetId = new RegExp("/spreadsheets/d/([a-zA-Z0-9-_]+)").exec(resourceUrl)[1];
				var url = window.location.href;
				if (url.indexOf('?') > -1){
					url += '&sheetId=' + spreadsheetId;
				}
				else{
					url += '?sheetId=' + spreadsheetId;
				}
				window.location.href = url;
			}
//			function toggleItem(id){
//				$('#' + id).toggle();
//			}

			function getURLParam(name){
				return (location.search.split(name + '=')[1] || '').split('&')[0];
			}

			function startDecisions()
			{
				$("#start-btn").toggle();
				$("#vars-menu").show();
				var decisionsTree = JSON.parse(localStorage.getItem('CG-decisionsTree'));
				var decisionsDiv = $('<div/>').attr({id:'decisions'});
				var pickOption = $('<div/>').attr({id:'pick-option'});
				var content = $("#content");
				content.append(decisionsDiv);
				content.css('background-color', '#ffffff');
				//var ids = [];
				genChoices(decisionsTree, false); // first call to genHTML
			}

			function genHTMLContent(item)
			{
				//debugger;
//				if (item.used) // .toLowerCase() === "true"
//					return;
				var exists = $('#' + item.id);
				if (exists.length > 0)
					return false;
				var innerDiv = $('<div/>').attr({id:item.id});
				var decisionsDiv = $("#decisions");
				var htmlTag = "";

				if (item.type === 'paragraph')
					htmlTag = "<p>";
				else if (item.type === 'title')
					htmlTag = "<h1>";
				else if (item.type === 'subtitle')
					htmlTag = "<h2>";

				var content = $(htmlTag).html(item.content); // change to .text to not parse as HTML
				innerDiv.append(content);
				decisionsDiv.append(innerDiv);

				var match = item.content.match(/{{\s*[\w\.]+\s*}}/g);
				if (match)
				{
					var vueTemp = match.map(function(x) { return x.match(/[\w\.]+/)[0]; });
					if (vueTemp.length > 0)
					{
						updateVarsMenu(vueTemp, item.id);
					}
				}
				return true;
			}

			function updateVarsValue(data){
				var content = document.getElementById("content");
				var classes = content.getElementsByClassName(data.placeholder);
				var len = Object.keys(classes).length;
				var val = data.value;
				if (val === "")
					val = data.placeholder;
				for (var i = 0; i < len; i++)
					classes[i].innerText = val;
			}

			function updateVarsMenu(arr, id)
			{
				var vueVars = JSON.parse(localStorage.getItem('CG-vueVars'));
				if (!(vueVars instanceof Array))
					vueVars = [];
				var newVars = $(arr).not(vueVars).get();
				debugger;
				$(arr).each(function(index){
					var varName = "{{" + this + "}}";
					if (newVars.length > 0) // means there's new vars
					{
						var varDiv = $('<div/>').attr({id:'var_' + this});
						var paragraph = $('<p>').text(varName);
						var input = $('<input/>').attr({type:'text', class:'vue-var', placeholder:varName, oninput:"updateVarsValue(this)"});
						paragraph.append(input);
						varDiv.append(paragraph);
						$("#vars-menu").append(varDiv);
					}
					// update var from HTML
					var pattern = new RegExp(varName, 'g');
					var content = $("#" + id);
					var newHTML = content.html().replace(pattern, '<abbr class="' + varName + '">' + varName + '</abbr>');
					content.html(newHTML);
				});
				$.extend(vueVars, arr);
				localStorage.setItem('CG-vueVars', JSON.stringify(vueVars));
			}

			function genChoices(json, replaceJson)
			{
				//debugger;
				var decisionsDiv = $("#decisions");
//				var pickOption = $("#pick-option");
//				if (pickOption)
//					pickOption.remove();
				$("#pick-option").remove();
				var ids = JSON.parse(localStorage.getItem('CG-brothersIds'));
				var replaced = false;
				var buildNewIds = false;
				if (ids instanceof Array)
				{
					if ((ids.length > 0) && (replaceJson))
					{
						json = ids;
						replaced = true;
					}
				}
				else
				{
					ids = [];
					buildNewIds = true;
				}
				var pickOption = $('<div/>').attr({id:'pick-option'});
				var found = false;
				var i = 0;
				$(json).each(function(index){
					//debugger;
					if (!found)
					{
						if (this.mandatory.toLowerCase() === "true")
						{
							found = !genHTMLContent(this);
							this.used = true;
						}
						else // TODO when brothers, must be able to choose all of them
						{
							//ids.push(this.id);
							//this.description
							var innerDiv = $('<div/>').attr({id:'pick-inner'});
							var paragraph = $('<p>').text('Use "' + this.description + '"?');
							var btnYes = $('<input/>').attr({class:'btn btn-primary btn-pick no-print', id:'btn_' + this.id, type: 'button', value:'Yes', onClick:"parseJson(true, '" + this.id + "', '')"});
							var btnNo = $('<input/>').attr({class:'btn btn-primary btn-pick no-print', id:'btn_' + this.id, type: 'button', value:'No', onClick:"parseJson(false, '" + this.id + "', '')"});
							innerDiv.append(paragraph).append(btnYes).append(btnNo);
							pickOption.append(innerDiv);
							found = true;
						}
						if (replaced)
						{
							ids.splice(index - i, 1); // remove current item
							i++;
						}
					}
					else if (buildNewIds)
						ids.push(this);
					else if (!replaceJson) // if it's not replacing the json, means that it's not using ids, so increment
						ids.unshift(this);
				});
				decisionsDiv.append(pickOption);
				localStorage.setItem('CG-brothersIds', JSON.stringify(ids));
			}

			function parseJson(add, item, json)
			{
				//debugger;
				$("#pick-option").remove();
				var found = false;
				if (json === "")
					json = JSON.parse(localStorage.getItem('CG-decisionsTree'));
				if (add)
				{
					$(json).each(function(index){
						if (!found)
						{
							//debugger;
							if (this.id === item)
							{
								found = genHTMLContent(this);
								this.used = true;
								if (this.childs.length > 0)
								{
									//debugger;
									genChoices(this.childs, false);
								}
								else
									genChoices(json, true);
							}
							else if (this.childs.length > 0)
							{
								//debugger;
								found = parseJson(add, item, this.childs);
							}
						}
					});
				}
				else
				{
					genChoices(json, true);
				}

				return found;
			}

			function preparePrint()
			{
				window.print();
			}
		</script>
	</footer>
</html>