<html>
	<head>
		<!-- Load jQuery, Vue and Sheetrock from CDNJS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.js"></script>-->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.1.4/dist/sheetrock.min.js"></script>
		<script src="js/contract-generator.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">

		<link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAEQklEQVRoge1aPUvrUBh+Yq2itdgqlqqL1kUXF7WIk2hBcVFx0dFNHHSo4CIu/oHOjuIn6KBoN4W6tH4UVERBEYoR/Eao1BakzR0u6U2Tk+SkOfbe4T5QePOe9ysnT96Tk5TLZDICGOLj4wNvb28KfV1dHWw2G8tUAIBijuOYBjw8PMTq6ioEQYA09uzsLNra2pjmAoAiABCEPxeBlSwek8alerNysfRAxPn5Oc7Ozohn7PV60dzcDEEQsLS0pBi/u7tT6ARBwMHBAS4vL3P0lZWVGBwcBACEw2Hc3NwofC0WC7q6utDY2EicDAWFtre3sbKykjUSx0W5pqYGLS0tyGQy2NvbI9qIkMonJyeK4urr6zE0NAQAuLi4wP7+vsIGAHZ3d+H3+9HR0aEYU1BobW2NGEQKOVW07FhQJZ1OY2Njg2ijoBCJx0bgdrvR39+v0K+vryOZTFLFM3K/6XYhKT2kOrVCqqqqMDAwoNBvbW0hlUqpxpfLWrVIUSwWZ6Sd6s1iJpNhFkvNXpxEYheSo7W1FWNjYwCA6upqzQRXV1cYHR01XNjw8DB8Ph8AIBAI4OnpSbV4qUy1kNlsNjQ1NeXoOI6D1+vF0dGRqp9e7M7OzqyNy+WCy+UCAFitVqKvKQqJNrFYDMlkEgAwPj4Oq9WK4+NjQ7QpKSlBb28vfD4frq+vAQAOhwNut1vX1zCF5JdtcXERt7e34DgOk5OTmJqaoi5cjuXlZezs7AAAenp6MDExQcyrVgsAFHEcB+lPDlFHGg8Gg0ilUpDHoPm9v78jFArlxCXJWjqO44xTSIpYLAa/3w+v1wuHw6HpL8XLywvC4TASiYRiJSflI8183hSS4/X1FcFgUDOpHmhyq9VCvZDl89ht1EdvUWPShaTo7u6G0+k0VKQU9/f3iEajOTn0wJRCfX198Hg8hgsXEQqFcHp6qptXqxbTFDK7o1OjTUEotLCwAIvFYqxiCb6/v/9uF/r6+lLd0PzvQoWg0Pz8PBoaGqiKm56eRjwe17xapBmX52RKobKyMsPvevQWRvkYsx0ZyS4ajYLneYqyf9+wRnZcBaHQ5uYm1U0s3YKqyXIfPRtDOzJSAiOg2aTn60v9apFk197eDrvdTuUvIplMIhKJ6OYoCIVGRkbg8XhUX2yRaPD4+IhIJPJvdCFaG7UF6a93oUAgAKvVqukvRzqdpnquKgiFnp+f/3chs76muhBrn3wopHg7rYafnH0pC2gagtTecBcqLy9HRUVFPueiidLSUmJe5l1obm7OfLUU+FEK0d6U8sttRlaLSdWFeJ7PfiEpBOLxeFZm0oUeHh7A87xqv9eT8wFzCuULo9T7kS6U70zSdhIzsoJCdrs9h4OsaZAv7HY7HYVmZmYMP+OrgVUXqq2tzX47kNtwAoE7iUQCn5+fTE6CBZxOp2KhE8Gx/rdKoVGk9XXEjEzzzpOF/AspYYvTtx7s2AAAAABJRU5ErkJggg==" rel="icon" type="image/x-icon" />
		<title>Contract Generator</title>
	</head>
	<body>
		<div id="main">
			<!--all content goes here-->
			<div id="content">
				<h2 id="main-message">Loading...</h2>
			</div>
			<div id="vars-menu" class="no-print">
				<h3 class="menu-title">Menu</h3>
				<input id="print" type="button" class="btn btn-success" onclick="preparePrint()" value="Print!">
				<hr/>
				<h3 class="menu-title">Margin</h3>
				<p>Margin Top: <input type="number" class="margin-top form-control" value="30" oninput="updateMargin(this)"></p>
				<p>Margin Right: <input type="number" class="margin-right form-control" value="20" oninput="updateMargin(this)"></p>
				<p>Margin Bottom: <input type="number" class="margin-bottom form-control" value="20" oninput="updateMargin(this)"></p>
				<p>Margin Left: <input type="number" class="margin-left form-control" value="30" oninput="updateMargin(this)"></p>
				<hr/>
				<h3 class="menu-title">Variables</h3>
				<div id="margin">

				</div>
			</div>
		</div>
	</body>
	<footer>
		<script>
			// globals
			var docObject = [];
			var collDependency = [];
			var collection;

			function findFather(objSearch, objAdd, idx)
			{
				var found = false;
				objSearch.filter(function(item){ // find item father of the dependency
					if (!found)
					{
						if (item.id === objAdd.depends)
						{
							collDependency.splice(idx, 1); // remove current item
							item.childs.push(objAdd);
							found = true;
						}
						else if (item.childs.length > 0)
						{
							found = findFather(item.childs, objAdd, idx);
						}
					}
				});
				return found;
			}

			var myCallback = function (error, options, response) {
				if (!error) {
					debugger;
					//console.log(response.rows);
					// making sure it will work even if order changes
					var idIndex = response.rows[0].labels.indexOf('id');
					var descriptionIndex = response.rows[0].labels.indexOf('description');
					var contentIndex = response.rows[0].labels.indexOf('content');
					var typeIndex = response.rows[0].labels.indexOf('type');
					var dependsIndex = response.rows[0].labels.indexOf('depends');
					var mandatoryIndex = response.rows[0].labels.indexOf('mandatory');

					collection = response.rows.slice(1, response.rows.length); // remove labels
					collection.filter(function(item){ // get all objects that has no dependency
						if (item.cellsArray[dependsIndex] === "")
						{
							var tempObject = Object();
							tempObject.id = item.cellsArray[idIndex];
							tempObject.description = item.cellsArray[descriptionIndex];
							tempObject.content = item.cellsArray[contentIndex];
							tempObject.type = item.cellsArray[typeIndex];
							tempObject.depends = item.cellsArray[dependsIndex];
							tempObject.mandatory = item.cellsArray[mandatoryIndex];
							tempObject.used = false;
							tempObject.childs = [];

							docObject.push(tempObject);
						}
					});
					collDependency = collection.filter(function(item){ // get all objects that has dependency
						return (item.cellsArray[dependsIndex] !== "");
					});
					// TODO add while to deep decision tree
					var tempColl = [];
					var i = 0;
					var stop = false;
					var message = "";
					//while (collDependency.length > 0) {
					while ((!stop) && (collDependency.length > 0)) {
						tempColl = collDependency;
						$(tempColl).each(function(index){
							if (!stop)
							{
								var tempObject = Object();
								tempObject.id = this.cellsArray[idIndex];
								tempObject.description = this.cellsArray[descriptionIndex];
								tempObject.content = this.cellsArray[contentIndex];
								tempObject.type = this.cellsArray[typeIndex];
								tempObject.depends = this.cellsArray[dependsIndex];
								tempObject.mandatory = this.cellsArray[mandatoryIndex];
								tempObject.used = false;
								tempObject.childs = [];

								if (tempObject.id === tempObject.depends)
								{
									stop = true;
									message = "an item cannot depend of itself";
									return;
								}

								stop = !findFather(docObject, tempObject, index - i);
								i++;
							}
						});

						if (stop)
						{
							if (message !== "")
								window.alert(message);
						}
					}

					localStorage.setItem('CG-decisionsTree', JSON.stringify(docObject));
					localStorage.removeItem('CG-brothersIds');
					localStorage.removeItem('CG-vueVars');

					var startBtn = $('<input/>').attr({class:'btn btn-primary', id:'start-btn', type: 'button', value:'Start', onClick:'startDecisions()'});
					$("#content").append(startBtn);
					$("#main-message").text("Let's get started :D");
				}
			};
			var sheetId = getURLParam("sheetId"); // 1HFGm_cSH_XeZtxfREusftu-4S1LYZeAVSVjWMmsRHtY
			if (sheetId)
			{
				sheetrock({
					url: "https://docs.google.com/spreadsheets/d/" + sheetId + "/edit#gid=0",
					callback: myCallback
				});
			}
			else{
				var innerDiv = $('<div/>').attr({id:'parse-sheet'});
				var paragraph = $('<p>').text("Paste your spreadsheet URL").attr({class:'align-center'});
				var input = $('<input/>').attr({type:'text', id:'sheet-input', class:'form-control', placeholder:'Example: https://docs.google.com/spreadsheets/d/1HFGm_cSH_XeZtxfREusftu-4S1LYZeAVSVjWMmsRHtY/edit#gid=0'});
				var startBtn = $('<input/>').attr({class:'btn btn-primary', id:'sheet-btn', type: 'button', value:'Go!', onClick:'parseSpreadsheet()'});
				paragraph.append(input);
				innerDiv.append(paragraph).append(startBtn);
				$("#content").append(innerDiv);
			}

			function parseSpreadsheet()
			{
				var resourceUrl = $("#sheet-input").val();
				var spreadsheetId = new RegExp("/spreadsheets/d/([a-zA-Z0-9-_]+)").exec(resourceUrl)[1];
				var url = window.location.href;
				if (url.indexOf('?') > -1){
					url += '&sheetId=' + spreadsheetId;
				}
				else{
					url += '?sheetId=' + spreadsheetId;
				}
				window.location.href = url;
			}
//			function toggleItem(id){
//				$('#' + id).toggle();
//			}

			function updateMargin(data){
				var margin = data.className.split(' ')[0]; // get first class name
				var content = $("#content");

				if (margin === "margin-top")
					content.css('padding-top', data.value + "mm");
				if (margin === "margin-right")
					content.css('padding-right', data.value + "mm");
				if (margin === "margin-bottom")
					content.css('padding-bottom', data.value + "mm");
				if (margin === "margin-left")
					content.css('padding-left', data.value + "mm");
			}

			function getURLParam(name){
				return (location.search.split(name + '=')[1] || '').split('&')[0];
			}

			function startDecisions()
			{
				$("#start-btn").toggle();
				$("#vars-menu").show();
				var decisionsTree = JSON.parse(localStorage.getItem('CG-decisionsTree'));
				var decisionsDiv = $('<div/>').attr({id:'decisions'});
				var pickOption = $('<div/>').attr({id:'pick-option'});
				var content = $("#content");
				content.append(decisionsDiv);
				content.css('background-color', '#ffffff');
				//var ids = [];
				genChoices(decisionsTree, false); // first call to genHTML
			}

			function genHTMLContent(item)
			{
				//debugger;
//				if (item.used) // .toLowerCase() === "true"
//					return;
				var exists = $('#' + item.id);
				if (exists.length > 0)
					return false;
				var innerDiv = $('<div/>').attr({id:item.id});
				var decisionsDiv = $("#decisions");
				var htmlTag = "";

				if (item.type === 'paragraph')
					htmlTag = "<p>";
				else if (item.type === 'title')
					htmlTag = "<h1>";
				else if (item.type === 'subtitle')
					htmlTag = "<h2>";

				var content = $(htmlTag).html(item.content); // change to .text to not parse as HTML
				innerDiv.append(content);
				decisionsDiv.append(innerDiv);

				var match = item.content.match(/{{\s*[\w\.]+\s*}}/g);
				if (match)
				{
					var vueTemp = match.map(function(x) { return x.match(/[\w\.]+/)[0]; });
					if (vueTemp.length > 0)
					{
						updateVarsMenu(vueTemp, item.id);
					}
				}
				return true;
			}

			function updateVarsValue(data){
				var content = document.getElementById("content");
				var classes = content.getElementsByClassName(data.placeholder);
				var len = Object.keys(classes).length;
				var val = data.value;
				if (val === "")
					val = data.placeholder;
				for (var i = 0; i < len; i++)
					classes[i].innerText = val;
			}

			function updateVarsMenu(arr, id)
			{
				var vueVars = JSON.parse(localStorage.getItem('CG-vueVars'));
				if (!(vueVars instanceof Array))
					vueVars = [];
				var newVars = $(arr).not(vueVars).get();
				//debugger;
				$(arr).each(function(index){
					var varName = "{{" + this + "}}";
					if (newVars.length > 0) // means there's new vars
					{
						var varDiv = $('<div/>').attr({id:'var_' + this});
						var paragraph = $('<p>').text(varName);
						var input = $('<input/>').attr({type:'text', class:'vue-var form-control', placeholder:varName, oninput:"updateVarsValue(this)"});
						paragraph.append(input);
						varDiv.append(paragraph);
						$("#vars-menu").append(varDiv);
					}
					// update var from HTML
					var pattern = new RegExp(varName, 'g');
					var content = $("#" + id);
					var newHTML = content.html().replace(pattern, '<abbr class="' + varName + '">' + varName + '</abbr>');
					content.html(newHTML);
				});
				$.extend(vueVars, arr);
				localStorage.setItem('CG-vueVars', JSON.stringify(vueVars));
			}

			function genChoices(json, replaceJson)
			{
				//debugger;
				var decisionsDiv = $("#decisions");
//				var pickOption = $("#pick-option");
//				if (pickOption)
//					pickOption.remove();
				$("#pick-option").remove();
				var ids = JSON.parse(localStorage.getItem('CG-brothersIds'));
				var replaced = false;
				var buildNewIds = false;
				if (ids instanceof Array)
				{
					if ((ids.length > 0) && (replaceJson))
					{
						json = ids;
						replaced = true;
					}
				}
				else
				{
					ids = [];
					buildNewIds = true;
				}
				var pickOption = $('<div/>').attr({id:'pick-option'});
				var found = false;
				var i = 0;
				$(json).each(function(index){
					//debugger;
					if (!found)
					{
						if (this.mandatory.toLowerCase() === "true")
						{
							found = !genHTMLContent(this);
							this.used = true;
						}
						else // TODO when brothers, must be able to choose all of them
						{
							//ids.push(this.id);
							//this.description
							var innerDiv = $('<div/>').attr({id:'pick-inner'});
							var paragraph = $('<p>').text('Use "' + this.description + '"?');
							var btnYes = $('<input/>').attr({class:'btn btn-primary btn-pick no-print', id:'btn_' + this.id, type: 'button', value:'Yes', onClick:"parseJson(true, '" + this.id + "', '')"});
							var btnNo = $('<input/>').attr({class:'btn btn-primary btn-pick no-print', id:'btn_' + this.id, type: 'button', value:'No', onClick:"parseJson(false, '" + this.id + "', '')"});
							innerDiv.append(paragraph).append(btnYes).append(btnNo);
							pickOption.append(innerDiv);
							found = true;
						}
						if (replaced)
						{
							ids.splice(index - i, 1); // remove current item
							i++;
						}
					}
					else if (buildNewIds)
						ids.push(this);
					else if (!replaceJson) // if it's not replacing the json, means that it's not using ids, so increment
						ids.unshift(this);
				});
				decisionsDiv.append(pickOption);
				localStorage.setItem('CG-brothersIds', JSON.stringify(ids));
			}

			function parseJson(add, item, json)
			{
				//debugger;
				$("#pick-option").remove();
				var found = false;
				if (json === "")
					json = JSON.parse(localStorage.getItem('CG-decisionsTree'));
				if (add)
				{
					$(json).each(function(index){
						if (!found)
						{
							//debugger;
							if (this.id === item)
							{
								found = genHTMLContent(this);
								this.used = true;
								if (this.childs.length > 0)
								{
									//debugger;
									genChoices(this.childs, false);
								}
								else
									genChoices(json, true);
							}
							else if (this.childs.length > 0)
							{
								//debugger;
								found = parseJson(add, item, this.childs);
							}
						}
					});
				}
				else
				{
					genChoices(json, true);
				}

				return found;
			}

			function preparePrint()
			{
				window.print();
			}
		</script>
	</footer>
</html>